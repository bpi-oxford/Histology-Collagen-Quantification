# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

Automated collagen quantification pipeline for PSR (Picrosirius Red) + FG (Fast Green) stained histology images using color deconvolution and multi-level Otsu thresholding.

## Quick Commands

### Environment Setup

**First time setup - Clone with submodules:**
```bash
# New clone
git clone --recursive <repository-url>

# Existing clone - initialize submodules
git submodule update --init --recursive
```

**Docker (Production/HPC):**
```bash
# No longer requires GITHUB_TOKEN - uses local dependency/pyHisto submodule
git submodule update --init --recursive
docker build -t collagen-quant .
docker run -it --rm -v /path/to/data:/data collagen-quant
```

**Pixi (Local development - fastest):**
```bash
git submodule update --init --recursive
pixi install
pixi shell
pip install -e .
pip install -e ./dependency/pyHisto
python -m pip install histomicstk --find-links https://girder.github.io/large_image_wheels
```

**Conda (Traditional):**
```bash
git submodule update --init --recursive
conda env create -f env.yaml
conda activate collagen_quant
pip install -e .
pip install -e ./dependency/pyHisto
python -m pip install histomicstk --find-links https://girder.github.io/large_image_wheels
```

### Running Workflows

```bash
# Interactive mode (recommended)
bash python/decon.sh     # or: pixi run decon
bash python/seg.sh       # or: pixi run seg

# Direct invocation
python python/decon.py -i input.czi -o output/ -s 2 --stain_map stain_color_map/vectors.json -bn 16
python python/seg.py -i PSR.ome.tiff -o collagen.ome.tiff -m mask.ome.tiff -s res.csv -t 2048 -p 0 -c 1 --classes 4

# Jupyter
pixi run notebook    # Port 8888
```

## Architecture

### Core Modules (`python/`)

**`decon.py`** - Color deconvolution
- Reads WSI (CZI/TIFF/OME-TIFF) via `bioio`/`aicsimageio`
- Applies color deconvolution using HistomicsTK + QuPath stain vectors
- Outputs: `color_decon.ome.tiff`, `PSR.ome.tiff`, `mask.ome.tiff`
- Uses tiled processing with parallel batching

**`seg.py`** - Collagen segmentation
- Multi-level Otsu thresholding on PSR channel
- Tiled processing with configurable size/padding
- Outputs: `collagen.ome.tiff` (binary mask), `res.csv` (quantification)

**`decon.sh` / `seg.sh`** - Interactive wrappers
- TOML config management in `configs/decon/` and `configs/seg/`
- Batch processing with auto-discovery

### Key Dependencies

- **Image I/O**: `bioio`, `pyvips`, `tifffile`
- **Processing**: `histomicstk`, `scikit-image`, `numpy`, `scipy`
- **Geospatial**: `geopandas`, `rasterio` (for manual GeoJSON masks)
- **Private**: `pyHisto` (installed from `dependency/pyHisto` git submodule)

**Important dependencies**:
- `histomicstk` requires Java (JDK) and must be installed separately:
  ```bash
  python -m pip install histomicstk --find-links https://girder.github.io/large_image_wheels
  ```
- `pyHisto` is included as a git submodule in `dependency/pyHisto` and installed in editable mode

### Data Flow

```
Input WSI → [decon.py] → PSR.ome.tiff + mask.ome.tiff → [seg.py] → collagen.ome.tiff + res.csv
```

### Configuration

**Stain vectors** (`stain_color_map/*.json`): QuPath-compatible RGB vectors measured from actual images
**Workflow configs** (`configs/*.toml`): Auto-generated by shell scripts, reusable

## Platform Notes

- **Windows**: Requires libvips (run `setup_windows.sh`), uses `vips_path_windows.py` for PATH
- **HPC**: Docker supports Apptainer/Singularity, use `--platform=linux/amd64`
- **macOS/Linux**: Pixi installs libvips automatically via conda

## Critical Parameters

- **Memory**: Tile size (default 2048px), scaling factor, batch size
- **Stain vectors**: Must measure from your specific images in QuPath
- **Segmentation**: `class_id` (typically 1 for PSR collagen), padding (512px recommended)

## Documentation

- `README.MD` - Quick start
- `doc/quickstart.md` - Step-by-step tutorial
- `doc/installation.md` - Platform-specific setup
- `doc/workflows.md` - Parameters and troubleshooting
- `doc/file-formats.md` - I/O specifications
- `doc/docker.md` - Container deployment
- `notebook/` - Technical implementation details
